# 하이브리드 개발환경 사용 매뉴얼

## 📋 목차
1. [일상 개발 워크플로우](#일상-개발-워크플로우)
2. [필수 명령어 모음](#필수-명령어-모음)
3. [데이터베이스 관리](#데이터베이스-관리)
4. [빌드 및 배포](#빌드-및-배포)
5. [문제 해결](#문제-해결)
6. [유지보수](#유지보수)

---

## 🚀 일상 개발 워크플로우

### 1. **프로젝트 시작**
```bash
# 프로젝트 디렉토리 이동
cd /Users/admin/new_project/commerce-nextjs

# 환경변수 확인
cat .env | grep -E "(DATABASE_URL|REDIS_URL)"

# 서버 연결 상태 확인
npm run test:server
```

### 2. **로컬 개발 시작**
```bash
# 개발 서버 실행
npm run dev

# 또는 Vercel CLI로 실행 (권장)
vercel dev
```

### 3. **스키마 변경 시**
```bash
# 1. Drizzle 스키마 파일 수정
# drizzle/migrations/schema.ts

# 2. 변경사항을 SQL로 생성
npx drizzle-kit generate

# 3. 서버에 스키마 적용
npm run sync:schema
```

### 4. **배포 전 검증**
```bash
# 빌드 에러 체크
npm run build:check

# Vercel 환경 테스트 (배포 없음)
vercel build --prod

# 타입 검증
npm run typecheck
```

---

## 🛠️ 필수 명령어 모음

### **npm 스크립트 (package.json)**

#### 개발 관련
```bash
npm run dev              # 로컬 개발 서버 시작
npm run build           # 프로덕션 빌드
npm run start           # 프로덕션 서버 시작
npm run typecheck       # TypeScript 타입 검증
npm run lint           # ESLint 검사
```

#### 데이터베이스 관련
```bash
npm run test:server     # 서버 DB 연결 테스트
npm run test:drizzle    # Drizzle ORM 테스트
npm run sync:schema     # 스키마 서버 동기화
npm run migrate:server  # 서버로 마이그레이션
```

#### 빌드 검증 관련
```bash
npm run build:check     # 상세 빌드 검증
npm run build:analyze   # 번들 분석
npm run vercel:test     # Vercel 로컬 테스트
```

### **Drizzle 명령어**
```bash
# 스키마 생성/업데이트
npx drizzle-kit generate

# 데이터베이스 상태 확인
npx drizzle-kit introspect

# 마이그레이션 실행
npx drizzle-kit push
```

### **Vercel CLI 명령어**
```bash
# 로컬 개발 (Vercel 환경)
vercel dev

# 빌드만 실행 (배포 없음)
vercel build --prod

# 환경변수 확인
vercel env ls

# 프로젝트 정보
vercel project ls
```

### **서버 관리 명령어**
```bash
# 서버 SSH 접속
ssh root@141.164.60.51

# 서버 상태 확인
ssh root@141.164.60.51 'podman ps -a'

# 스토리지 용량 확인
ssh root@141.164.60.51 'df -h /mnt/blockstorage'

# 데이터베이스 상태
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "SELECT count(*) FROM users;"'
```

---

## 📊 데이터베이스 관리

### **연결 상태 확인**
```bash
# 전체 연결 테스트
npx tsx scripts/test-server-connection.ts

# Drizzle 연결만 테스트
npx tsx scripts/test-drizzle-connection.ts

# 기본 DB 연결 테스트
npm run test:server
```

### **스키마 관리 워크플로우**

#### 1. 새 테이블 추가
```typescript
// drizzle/migrations/schema.ts에 추가
export const newTable = pgTable('new_table', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 255 }).notNull(),
  created_at: timestamp('created_at').defaultNow(),
});
```

#### 2. 서버에 적용
```bash
# SQL 생성
npx drizzle-kit generate

# 서버에 수동 적용
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "CREATE TABLE new_table(...);"'
```

### **데이터 백업/복원**
```bash
# 서버 데이터베이스 백업
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 pg_dump -U nextjs_user nextjs_production > backup_$(date +%Y%m%d).sql'

# 백업 다운로드
scp root@141.164.60.51:~/backup_*.sql ./backups/

# 테이블별 데이터 확인
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "\dt"'
```

---

## 🚢 빌드 및 배포

### **로컬 빌드 검증 (필수)**

#### Vercel CLI 사용 (권장)
```bash
# 1. 개발 환경 테스트
vercel dev

# 2. 프로덕션 빌드 테스트 (배포 안함)
vercel build --prod

# 3. 환경변수 확인
vercel env ls
```

#### Next.js 직접 빌드
```bash
# 1. 타입 검증
npm run typecheck

# 2. 린트 검사
npm run lint

# 3. 빌드 실행
npm run build

# 4. 상세 빌드 체크
npm run build:check

# 5. 번들 분석 (옵션)
npm run build:analyze
```

### **서버 배포 준비**

#### 1. 배포 전 체크리스트
- [ ] 로컬 빌드 성공
- [ ] 서버 DB 연결 확인
- [ ] 환경변수 설정 확인
- [ ] 스키마 동기화 완료

#### 2. 서버 배포 (예정)
```bash
# Git을 통한 배포
git add .
git commit -m "feat: 새 기능 추가"
git push origin main

# 서버에서 빌드 및 배포 (구현 예정)
ssh root@141.164.60.51 './deploy-commerce.sh'
```

---

## 🔧 문제 해결

### **연결 문제**

#### 데이터베이스 연결 실패
```bash
# 1. 환경변수 확인
echo $DATABASE_URL

# 2. 서버 상태 확인
ssh root@141.164.60.51 'podman ps | grep postgres'

# 3. 포트 확인
ssh root@141.164.60.51 'netstat -tlnp | grep 5432'

# 4. 연결 테스트
npm run test:server
```

#### Redis 연결 문제
```bash
# Redis 컨테이너 상태
ssh root@141.164.60.51 'podman ps | grep redis'

# Redis 연결 테스트
ssh root@141.164.60.51 'redis-cli -h localhost -p 6379 -a hFAqbBwwLkzOMO4QEsGsw5Jck ping'
```

### **빌드 문제**

#### 타입 에러
```bash
# 타입 검증 실행
npm run typecheck

# Drizzle 스키마 재생성
npx drizzle-kit generate
```

#### 종속성 문제
```bash
# node_modules 재설치
rm -rf node_modules package-lock.json
npm install

# 캐시 정리
npm run build -- --no-cache
```

### **스키마 동기화 문제**

#### 로컬과 서버 스키마 불일치
```bash
# 1. 서버 스키마 확인
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "\d users"'

# 2. 로컬 스키마와 비교
npx drizzle-kit introspect

# 3. 수동 스키마 동기화
npm run sync:schema
```

---

## 🔄 유지보수

### **정기 점검 (주 1회)**

#### 시스템 상태 확인
```bash
# 1. 서버 연결 상태
npm run test:server

# 2. 스토리지 용량
ssh root@141.164.60.51 'df -h /mnt/blockstorage'

# 3. 데이터베이스 상태
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "SELECT pg_size_pretty(pg_database_size('\''nextjs_production'\''));"'

# 4. 컨테이너 상태
ssh root@141.164.60.51 'podman stats --no-stream'
```

#### 로그 확인
```bash
# 애플리케이션 로그
tail -f logs/app.log

# 서버 시스템 로그
ssh root@141.164.60.51 'journalctl -f -u podman'
```

### **백업 (주 1회)**
```bash
# 1. 데이터베이스 백업
./scripts/backup-database.sh

# 2. 스토리지 백업
rsync -av root@141.164.60.51:/mnt/blockstorage/projects/commerce/ ./backups/storage/

# 3. 설정 파일 백업
cp .env ./backups/config/env_$(date +%Y%m%d)
```

### **성능 모니터링**
```bash
# 1. 데이터베이스 성능
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "SELECT * FROM pg_stat_activity;"'

# 2. Redis 성능
ssh root@141.164.60.51 'redis-cli -p 6379 -a hFAqbBwwLkzOMO4QEsGsw5Jck info stats'

# 3. 스토리지 I/O
ssh root@141.164.60.51 'iostat -x 1 3'
```

---

## 📞 긴급 상황 대응

### **서버 다운 시**
1. **서버 상태 확인**: `ssh root@141.164.60.51`
2. **컨테이너 재시작**: `podman restart postgres_container redis_container`
3. **로그 확인**: `journalctl -xe`
4. **복구 후 연결 테스트**: `npm run test:server`

### **데이터 손실 시**
1. **즉시 백업 중단**
2. **최신 백업 파일 확인**: `ls -la backups/`
3. **복원 실행**: `./scripts/restore-database.sh backup_file.sql`
4. **데이터 정합성 확인**: `npm run test:data-integrity`

### **빌드 실패 시**
1. **에러 로그 확인**: `npm run build 2>&1 | tee build-error.log`
2. **의존성 재설치**: `rm -rf node_modules && npm install`
3. **Vercel 로컬 테스트**: `vercel build --prod`
4. **단계별 빌드**: `npm run typecheck && npm run lint && npm run build`

---

## 📚 추가 리소스

### **관련 문서**
- [하이브리드 개발환경 구축 가이드](./하이브리드-개발환경-구축-가이드.md)
- [프로젝트 관리 문서](./프로젝트관리.md)

### **유용한 도구**
- **Drizzle Studio**: `npx drizzle-kit studio`
- **PostgreSQL 클라이언트**: TablePlus, pgAdmin
- **Redis 클라이언트**: RedisInsight
- **서버 모니터링**: htop, iotop

### **도움말**
- **Drizzle ORM**: https://orm.drizzle.team/
- **Vercel CLI**: https://vercel.com/docs/cli
- **Next.js**: https://nextjs.org/docs

---

*최종 업데이트: 2025년 9월 4일*  
*환경: 하이브리드 개발환경 (로컬 + 서버 141.164.60.51)*