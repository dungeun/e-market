# 하이브리드 개발환경 구축 완료 가이드

## 📋 프로젝트 개요

**로컬 개발 + 서버 리소스** 하이브리드 아키텍처로 Supabase와 유사한 개발 환경 구축

```
┌─────────────────┐    ┌──────────────────────────────────┐
│   로컬 개발환경    │────│      서버 (141.164.60.51)       │
│                │    │                                │
│ • Next.js 코딩  │    │ • PostgreSQL (nextjs_production)│
│ • Drizzle 스키마 │◄───│ • Redis (인증)                  │
│ • Vercel CLI    │    │ • 블록 스토리지 (98GB)           │
│ • 개발서버만     │    │ • Podman 컨테이너 관리           │
└─────────────────┘    │ • PowerDNS 관리                 │
                      └──────────────────────────────────┘
```

---

## 🏗️ 서버 아키텍처

### 멀티테넌트 PaaS 구조
```
서버 (141.164.60.51)
├─ Podman 컨테이너 관리
│  ├─ 프로젝트A/
│  │  ├─ PostgreSQL 컨테이너 (포트: 5433)
│  │  ├─ Redis 컨테이너 (포트: 6380)
│  │  └─ 스토리지 볼륨
│  │
│  ├─ commerce-nextjs/ (현재 프로젝트)
│  │  ├─ PostgreSQL 컨테이너 (포트: 5432)
│  │  ├─ Redis 컨테이너 (포트: 6379)
│  │  └─ 블록스토리지 (/mnt/blockstorage/projects/commerce/)
│  │
│  └─ 프로젝트C/
│     ├─ PostgreSQL 컨테이너 (포트: 5434)
│     └─ Redis 컨테이너 (포트: 6381)
│
├─ PowerDNS (통합 도메인 관리)
└─ 프로젝트별 환경변수 관리
```

### 현재 프로젝트 리소스
- **PostgreSQL**: `nextjs_production` DB (포트 5432)
- **Redis**: 인증키 `hFAqbBwwLkzOMO4QEsGsw5Jck` (포트 6379)
- **블록 스토리지**: `/mnt/blockstorage/projects/commerce/` (98GB)
- **격리 환경**: 다른 프로젝트와 완전 독립

---

## 🔧 구축 과정 상세

### 1. 환경 분석 및 설정

#### 서버 리소스 확인
```bash
# SSH 접속으로 서버 환경 분석
ssh root@141.164.60.51

# 스토리지 확인
df -h /mnt/blockstorage
# 결과: 98GB 블록 스토리지 사용 가능

# Podman 컨테이너 확인
podman ps -a
```

#### 환경변수 설정
```env
# .env 파일
DATABASE_URL=postgresql://nextjs_user:ITeRgI4nxSZCaefOaheYJLnA5@141.164.60.51:5432/nextjs_production
DB_HOST=141.164.60.51
DB_PORT=5432
DB_NAME=nextjs_production
DB_USER=nextjs_user
DB_PASSWORD=ITeRgI4nxSZCaefOaheYJLnA5

REDIS_URL=redis://:hFAqbBwwLkzOMO4QEsGsw5Jck@141.164.60.51:6379
REDIS_HOST=141.164.60.51
REDIS_PORT=6379
REDIS_PASSWORD=hFAqbBwwLkzOMO4QEsGsw5Jck
```

### 2. Drizzle ORM 설치 및 설정

#### 패키지 설치
```bash
npm install drizzle-orm drizzle-kit pg @types/pg dotenv
```

#### Drizzle 설정
```typescript
// drizzle.config.ts
import type { Config } from "drizzle-kit";

export default {
  schema: "./drizzle/migrations/schema.ts",
  out: "./drizzle/migrations",
  dialect: "postgresql",
  dbCredentials: {
    url: "postgresql://nextjs_user:ITeRgI4nxSZCaefOaheYJLnA5@141.164.60.51:5432/nextjs_production",
  },
} satisfies Config;
```

### 3. 데이터베이스 마이그레이션

#### 로컬 스키마 추출
```bash
# 로컬 DB에서 스키마 추출
npx drizzle-kit introspect --config=drizzle.config.ts
```

#### 서버 DB 준비
```bash
# PostgreSQL 확장 설치
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U nextjs_user -d nextjs_production -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"; CREATE EXTENSION IF NOT EXISTS \"pgcrypto\";"'

# 데이터베이스 생성 확인
ssh root@141.164.60.51 'PGPASSWORD=ITeRgI4nxSZCaefOaheYJLnA5 psql -U postgres -c "CREATE DATABASE nextjs_production OWNER nextjs_user;"'
```

#### 스키마 및 데이터 마이그레이션
```bash
# 마이그레이션 스크립트 실행
npx tsx scripts/migrate-to-server.ts
npx tsx scripts/copy-data-to-server.ts
```

**마이그레이션 결과:**
- ✅ **29개 테이블** 마이그레이션 완료
- ✅ **259개 데이터 레코드** 복사 완료
- ✅ 테이블 목록: users, products, categories, orders, language_packs 등

### 4. 파일 동기화

#### 이미지 파일 서버 동기화
```bash
# rsync로 이미지 파일 동기화
rsync -avz --progress public/ root@141.164.60.51:/mnt/blockstorage/projects/commerce/public/
```

**동기화 결과:**
- ✅ **56개 이미지 파일** (44.9MB)
- ✅ 서버 경로: `/mnt/blockstorage/projects/commerce/public/`

### 5. Drizzle 통합

#### Database 클래스 업데이트
```typescript
// lib/db.ts 주요 변경사항
import { drizzle } from 'drizzle-orm/node-postgres';
import type { NodePgDatabase } from 'drizzle-orm/node-postgres';
import { sql } from 'drizzle-orm';
import * as schema from '../drizzle/migrations/schema';
import * as relations from '../drizzle/migrations/relations';

class Database {
  private drizzle: NodePgDatabase<typeof schema>;
  
  constructor() {
    this.pool = new Pool(config);
    this.drizzle = drizzle(this.pool, { schema: { ...schema, ...relations } });
  }
  
  public getDrizzle(): NodePgDatabase<typeof schema> {
    return this.drizzle;
  }
  
  public async testDrizzleConnection() {
    // Drizzle 연결 테스트 로직
  }
}
```

#### 연결 테스트 성공
```bash
npx tsx scripts/test-server-connection.ts
```

**테스트 결과:**
- ✅ 서버 연결 성공: `nextjs_production` 데이터베이스
- ✅ Drizzle ORM 통합: **27개 테이블** 인식
- ✅ 데이터 확인: **1명 사용자** 데이터 존재

---

## 🔄 개발 워크플로우

### 스키마 관리
1. **로컬 개발**: Drizzle 스키마 파일로 테이블 정의
   ```typescript
   // drizzle/migrations/schema.ts
   export const newTable = pgTable('new_table', {
     id: uuid('id').defaultRandom().primaryKey(),
     name: varchar('name', { length: 255 }).notNull(),
   });
   ```

2. **서버 동기화**: Drizzle → SQL 변환하여 서버 적용
   ```bash
   npx drizzle-kit generate  # SQL 생성
   # 서버에 직접 SQL 적용
   ```

### 로컬 빌드 검증 (Vercel 스타일)
```bash
# Vercel CLI로 로컬 테스트 (배포 없음)
npm i -g vercel
vercel build --prod    # 프로덕션 빌드만
vercel dev            # Vercel 환경 시뮬레이션

# 또는 Next.js 직접 빌드
npm run build:check
npm run typecheck
npm run lint:strict
```

### 개발 → 프로덕션 배포
```
로컬 개발 → Vercel CLI 검증 → Git Push → 서버 빌드 → Podman 배포
```

---

## 📊 최종 구축 결과

### ✅ 완성된 하이브리드 시스템

| 구분 | 환경 | 역할 |
|------|------|------|
| **로컬** | Next.js + Drizzle | 코딩, 스키마 정의, 빌드 검증 |
| **서버** | PostgreSQL + Redis + Storage | 모든 데이터 및 인프라 |

### ✅ 주요 성과
- **데이터베이스**: 로컬 → 서버 완전 마이그레이션
- **스키마 관리**: Drizzle ORM 타입 안전성
- **파일 스토리지**: 서버 블록 스토리지 활용
- **격리 환경**: 프로젝트별 독립된 리소스
- **빌드 검증**: Vercel CLI로 로컬 테스트

### ✅ 개발 효율성
- **Supabase 수준**: BaaS 경험과 동일
- **비용 효율**: 자체 서버 활용
- **확장성**: Podman 기반 멀티 프로젝트
- **개발 속도**: 로컬 개발 + 서버 리소스

---

## 🔧 유지보수 가이드

### 정기 점검 항목
1. **서버 연결 상태**
   ```bash
   npx tsx scripts/test-server-connection.ts
   ```

2. **스토리지 용량**
   ```bash
   ssh root@141.164.60.51 'df -h /mnt/blockstorage'
   ```

3. **Podman 컨테이너 상태**
   ```bash
   ssh root@141.164.60.51 'podman ps -a'
   ```

### 백업 전략
- **데이터베이스**: 정기 PostgreSQL 덤프
- **스토리지**: rsync 기반 파일 백업
- **설정**: 환경변수 및 Podman 설정 백업

---

## 🚀 다음 단계

1. **CI/CD 구축**: Gitea Actions 또는 Jenkins 설치
2. **모니터링**: 서버 리소스 모니터링 시스템
3. **로드밸런싱**: 트래픽 증가 시 스케일링
4. **보안 강화**: SSL, 방화벽, 액세스 제어

---

*구축 일시: 2025년 9월 4일*  
*환경: Next.js + Drizzle ORM + PostgreSQL + Redis + 블록 스토리지*  
*서버: 141.164.60.51 (Podman 기반 멀티테넌트)*